<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–∏–∑—Ä–∞–∫</title>
  <style>
    body { margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; background: #f0f0f0; }
    model-viewer { width: 100%; height: 100%; background: transparent; display: none; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 10; }
    .ar-button { padding: 15px 30px; background: #6200ea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; }
    .ar-button:hover { background: #3700b3; }
    .error-message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ff4444; color: white; padding: 10px; border-radius: 5px; z-index: 20; display: none; }
  </style>
</head>
<body>
  <!-- Import model-viewer and polyfills -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
  <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.8.0/webcomponents-loader.js"></script>
  <script src="https://unpkg.com/intersection-observer@0.12.2/intersection-observer.js"></script>
  <script src="https://unpkg.com/resize-observer-polyfill@1.5.1/dist/ResizeObserver.js"></script>
  <script src="https://unpkg.com/fullscreen-polyfill@0.2.0/dist/fullscreen.polyfill.js"></script>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <button class="ar-button" onclick="startAR()">üëã –í—ã –≥–æ—Ç–æ–≤—ã?</button>
  </div>

  <!-- Error message -->
  <div class="error-message" id="errorMessage"></div>

  <!-- Model viewer with AR support -->
  <model-viewer
    id="ghostModel"
    alt="Animated Ghost Model"
    src="https://raw.githubusercontent.com/HoneyAffect/arjs-models/main/ghost-move.glb"
    ios-src="https://raw.githubusercontent.com/HoneyAffect/arjs-models/main/ghost-ios-check.usdz"
    ar
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor"
    ar-scale="fixed"
    camera-controls
    touch-action="pan-y"
    auto-play
  ></model-viewer>

  <script>
    const modelViewer = document.querySelector('model-viewer#ghostModel');
    const loadingOverlay = document.querySelector('#loadingOverlay');
    const errorMessage = document.querySelector('#errorMessage');

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ —ç—Ç–æ iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // Preload model and adjust for iOS
    modelViewer.addEventListener('load', () => {
      modelViewer.style.display = 'block';
      loadingOverlay.style.display = 'none';
      console.log('–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');

      if (isIOS) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è iOS
        modelViewer.model.scale.set(5, 5, 5); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤ 5 —Ä–∞–∑
        // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≤ –Ω–æ–≤–æ–º .usdz
        // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –ª–µ–∂–∏—Ç, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
        // modelViewer.model.rotation.set(Math.PI / 2, 0, 0); // 90 –≥—Ä–∞–¥—É—Å–æ–≤ –ø–æ X
        console.log('–ú–∞—Å—à—Ç–∞–± —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ iOS:', {
          scale: modelViewer.model.scale,
          rotation: {
            x: modelViewer.model.rotation.x,
            y: modelViewer.model.rotation.y,
            z: modelViewer.model.rotation.z
          }
        });
      }
    });

    // Apply transparency and preserve textures
    modelViewer.addEventListener('model-loaded', () => {
      const scene = modelViewer.scene;
      scene.traverse((node) => {
        if (node.isMesh) {
          node.material.opacity = 0.4;
          node.material.transparent = true;
          node.material.needsUpdate = true;

          // Log texture info
          const texture = node.material.map;
          console.log(`Mesh ${node.name}:`, {
            hasTexture: !!texture,
            textureSource: texture ? texture.image.src : 'No texture'
          });
        }
      });
      console.log('–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ —Ç–µ–∫—Å—Ç—É—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
    });

    // Handle errors
    modelViewer.addEventListener('error', (event) => {
      errorMessage.textContent = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞';
      errorMessage.style.display = 'block';
      loadingOverlay.style.display = 'none';
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', event);
    });

    // Fix model position in AR
    modelViewer.addEventListener('ar-status', (event) => {
      if (event.detail.status === 'session-started') {
        modelViewer.interactionPrompt = 'none';
        modelViewer.scene.addEventListener('before-render', () => {
          modelViewer.model.position.set(0, 0, 0);
        });
        modelViewer.style.display = 'block';
        if (modelViewer.availableAnimations && modelViewer.availableAnimations.length > 0) {
          modelViewer.play();
          console.log('–ê–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω—ã –≤ AR:', modelViewer.availableAnimations);
        } else {
          console.log('–ê–Ω–∏–º–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –º–æ–¥–µ–ª–∏');
        }
      } else if (event.detail.status === 'failed') {
        errorMessage.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å AR. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–º–µ—Ä—É –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.';
        errorMessage.style.display = 'block';
        modelViewer.style.display = 'block';
        loadingOverlay.style.display = 'none';
      }
    });

    // Start AR
    function startAR() {
      modelViewer.activateAR();
      loadingOverlay.style.display = 'none';
    }
  </script>
</body>
</html>